<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f4f6ff" />
  <title>Ingrid 80 ‚Äî Galleri</title>
  <style>
    :root{
      --accent:#5b5ce2;
      --accent2:#7c3aed;
      --bg1:#f7f8ff;
      --bg2:#eef2ff;
      --card:#ffffffcc;
      --border:rgba(15,23,42,.12);
      --text:#0f172a;
      --muted:#475569;
      --shadow: 0 12px 34px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 20% 0%, rgba(91,92,226,.14), transparent 55%),
        radial-gradient(900px 650px at 85% 20%, rgba(124,58,237,.12), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
    }
    header{
      max-width:1100px;
      margin:0 auto;
      padding:18px 6px 8px;
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; font-weight:700; }
    .chip{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      border:1px solid var(--border);
      background:rgba(255,255,255,.7);
      padding:6px 10px;
      border-radius:999px;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:8px 6px 22px; }

    .toolbar{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      width:100%;
    }
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 8px 18px rgba(15,23,42,.08);
      user-select:none;
    }
    .btn.primary{
      border:none;
      color:white;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow: 0 12px 22px rgba(91,92,226,.22);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .btn:active{transform:translateY(1px)}
    .spacer{flex:1}
    .status{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      padding:2px 2px 0;
      line-height:1.35;
      width:100%;
    }
    input[type="file"]{ display:none; }

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width:560px){ .grid{grid-template-columns: repeat(5, minmax(0, 1fr));} }
    @media (min-width:900px){ .grid{grid-template-columns: repeat(7, minmax(0, 1fr));} }

    .tile{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--border);
      background:rgba(15,23,42,.03);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      cursor:pointer;
    }
    .tile img{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      display:block;
    }
    .badge{
      position:absolute;
      left:8px;
      bottom:8px;
      right:8px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      pointer-events:none;
    }
    .nameTag{
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
      background:rgba(255,255,255,.88);
      border:1px solid rgba(15,23,42,.10);
      border-radius:999px;
      padding:6px 10px;
      backdrop-filter: blur(6px);
    }

    .empty{
      margin-top:14px;
      padding:18px;
      border:1px dashed var(--border);
      border-radius:var(--radius);
      background:rgba(255,255,255,.55);
      color:var(--muted);
      font-weight:900;
      text-align:center;
    }

    /* Viewer modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:50;
      padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
      background:rgba(15,23,42,.40);
      align-items:center;
      justify-content:center;
    }
    .modal.open{display:flex}
    .card{
      width:min(980px, 96vw);
      background:rgba(255,255,255,.97);
      border:1px solid var(--border);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 26px 80px rgba(15,23,42,.30);
      display:flex;
      flex-direction:column;
    }
    .bar{
      display:flex; align-items:center; gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(15,23,42,.10);
    }
    .title{
      flex:1;
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .iconbtn{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:900;
    }
    .viewer{
      background:rgba(15,23,42,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      max-height:72vh;
    }
    .viewer img{
      width:100%;
      height:auto;
      max-height:72vh;
      object-fit:contain;
      user-select:none;
    }
    .footer{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding:12px;
      border-top:1px solid rgba(15,23,42,.10);
    }
    a.btnLink, button.btnLink{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(255,255,255,.96);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:60;
      box-shadow: 0 12px 30px rgba(15,23,42,.16);
      font-weight:900;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <header>
    <div>
      <h1>üì∏ Ingrid 80 ‚Äî Galleri</h1>
      <div class="sub" id="subText">Laddar bilder‚Ä¶</div>
    </div>
    <div class="chip" id="countChip">0 bilder</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="row">
        <button class="btn primary" id="refreshBtn">üîÅ Uppdatera</button>

        <label class="btn" for="fileInput" id="uploadLabel" title="V√§lj flera bilder fr√•n din telefon">
          üñºÔ∏è Ladda upp dina bilder
        </label>
        <!-- Opens phone gallery picker + multi select -->
        <input id="fileInput" type="file" accept="image/*" multiple />

        <span class="spacer"></span>
      </div>

      <div class="status" id="statusText"></div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none;">Inga bilder hittades √§nnu.</div>
  </div>

  <!-- Viewer -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Bildvisare">
    <div class="card">
      <div class="bar">
        <button class="iconbtn" id="closeBtn" aria-label="St√§ng">‚úï</button>
        <div class="title" id="modalTitle">Bild</div>
        <button class="iconbtn" id="copyBtn" aria-label="Kopiera l√§nk">‚ßâ</button>
      </div>

      <div class="viewer">
        <img id="modalImg" alt="" />
      </div>

      <div class="footer">
        <a class="btn btnLink" id="openBtn" target="_blank" rel="noopener">üîé √ñppna</a>
        <button class="btn btnLink" id="saveBtn" type="button">üì≤ Spara till Bilder</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // ===== CONFIG =====
  const CLOUD_NAME = "dtweoqypu";
  const UPLOAD_PRESET = "Ingrid80";

  // Option B: list by tag
  const EVENT_TAG = "ingrid80";     // <-- set this tag
  const EVENT_FOLDER = "Ingrid80";  // <-- optional; "" = root

  // Sheety (to map URLs -> player name, and to store per-player gallery)
  const SHEETY_API_URL = "https://api.sheety.co/19d52e6f83ab4563121d3da380c48d62/bingoPlayers/blad1";

  const AUTO_REFRESH_MS = 20000;

  const $ = (id) => document.getElementById(id);

  let allItems = [];          // [{ url, name }]
  let current = null;
  let isUploading = false;

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1600);
  }
  function setStatus(msg){ $("statusText").textContent = msg || ""; }

  function safeJsonParse(str, fallback){
    try { return JSON.parse(str); } catch { return fallback; }
  }

  function normalizeUrl(u){
    return String(u || "").trim().replace(/\s+/g, "");
  }

  function isCloudinaryUrl(url){
    try{ return new URL(url).hostname === "res.cloudinary.com"; }
    catch{ return false; }
  }

  function withTransform(url, transform){
    const needle = "/upload/";
    const i = url.indexOf(needle);
    if (i === -1) return url;
    const head = url.slice(0, i + needle.length);
    const tail = url.slice(i + needle.length);
    const t = String(transform || "").replace(/^\//,"").replace(/\/$/,"");
    return head + t + "/" + tail;
  }

  function thumbUrl(url){
    return (isCloudinaryUrl(url))
      ? withTransform(url, "f_auto,q_auto,w_600,h_600,c_fill,g_auto")
      : url;
  }

  function getMyId(){
    const params = new URLSearchParams(window.location.search);
    const idFromUrl = params.get("id");
    if (idFromUrl) return String(idFromUrl).trim();
    const stored = sessionStorage.getItem("playerId");
    return stored ? String(stored).trim() : "";
  }

  async function fetchPlayersMap(){
    // Builds a map: imageUrl -> playerName (based on what you store in Sheety.gallery)
    const map = new Map();

    try{
      const res = await fetch(SHEETY_API_URL, { cache: "no-store" });
      if (!res.ok) return map;
      const json = await res.json();
      const key = Object.keys(json)[0];
      const rows = json[key] || [];

      for (const row of rows){
        const name = (row?.name || "").trim() || "Ok√§nd";
        if (!row?.gallery) continue;

        const parsed = (typeof row.gallery === "string") ? safeJsonParse(row.gallery, row.gallery) : row.gallery;
        const arr = Array.isArray(parsed) ? parsed : [parsed];

        for (const u of arr){
          const nu = normalizeUrl(u);
          if (!nu) continue;
          if (!map.has(nu)) map.set(nu, name);
        }
      }
    }catch{
      // ignore
    }
    return map;
  }

async function fetchCloudinaryTagList() {
  const candidates = Array.from(new Set([
    EVENT_TAG,
    EVENT_TAG.toLowerCase(),
    EVENT_TAG.charAt(0).toUpperCase() + EVENT_TAG.slice(1),
  ]));

  let lastErrText = "";

  for (const tag of candidates) {
    const listUrl =
      `https://res.cloudinary.com/${CLOUD_NAME}/image/list/${encodeURIComponent(tag)}.json?t=${Date.now()}`;

    const res = await fetch(listUrl, { cache: "no-store" });

    if (res.ok) {
      const json = await res.json();
      // if this worked, update tag so UI tells the truth
      window.__ACTIVE_TAG__ = tag;
      return json;
    }

    // capture response text (Cloudinary often returns useful error strings)
    try { lastErrText = await res.text(); } catch {}

    // if it's NOT 404, it‚Äôs not ‚Äútag missing‚Äù ‚Äî bubble it up
    if (res.status !== 404) {
      throw new Error(`Cloudinary list error (HTTP ${res.status}) for tag "${tag}": ${lastErrText || "(no body)"}`);
    }
  }

  throw new Error(
    `Cloudinary list error (HTTP 404). Tag not found or list still restricted.\n` +
    `Tried: ${candidates.join(", ")}\n` +
    (lastErrText ? `Body: ${lastErrText}` : "")
  );
}


  function buildOriginalUrlFromListItem(r){
    // Standard delivery URL
    return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/v${r.version}/${r.public_id}.${r.format}`;
  }

  function render(items){
    const grid = $("grid");
    grid.innerHTML = "";

    $("countChip").textContent = `${items.length} bilder`;
    $("subText").textContent = items.length
      ? `Visar alla Cloudinary-bilder med tagg: ${EVENT_TAG}`
      : `Inga bilder hittades √§nnu.`;

    $("empty").style.display = items.length ? "none" : "block";

    for (const it of items){
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.addEventListener("click", ()=>openModal(it));

      const img = document.createElement("img");
      img.loading = "lazy";
      img.alt = "Bild";
      img.src = thumbUrl(it.url);

      const badge = document.createElement("div");
      badge.className = "badge";

      const nameTag = document.createElement("div");
      nameTag.className = "nameTag";
      nameTag.textContent = it.name || "Ok√§nd";

      tile.appendChild(img);
      grid.appendChild(tile);
    }
  }

  function openModal(item){
    current = item;
    const who = item.name ? `${item.name} ‚Äî ` : "";
    $("modalTitle").textContent = who + (item.url.split("/").pop() || "Bild");
    $("modalImg").src = item.url;
    $("openBtn").href = item.url;
    $("modal").classList.add("open");
  }

  function closeModal(){
    $("modal").classList.remove("open");
    $("modalImg").src = "";
    current = null;
  }

  async function copyCurrent(){
    if (!current?.url) return;
    try{
      await navigator.clipboard.writeText(current.url);
      toast("Kopierat!");
    }catch{
      toast("Kunde inte kopiera.");
    }
  }


function isDesktopDevice() {
  // ‚Äúpointer: coarse‚Äù is typically phones/tablets. Desktop mouse/trackpad is ‚Äúfine‚Äù.
  const coarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
  const touch = (navigator.maxTouchPoints || 0) > 0;
  return !(coarse || touch);
}

async function shareToPhonePhotos(url, filename) {
  try{
    if (!navigator.share) throw new Error("No Web Share");

    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error("Fetch failed: " + res.status);

    const blob = await res.blob();
    const type = blob.type || "image/jpeg";
    const safeName = (filename || "image.jpg").replace(/[^\w.\-]+/g, "_");
    const file = new File([blob], safeName, { type });

    if (navigator.canShare && !navigator.canShare({ files: [file] })) {
      throw new Error("canShare(files) false");
    }

    await navigator.share({
      title: "Spara bild",
      text: "V√§lj 'Spara bild' / 'L√§gg till i Bilder'",
      files: [file]
    });
  } catch (e) {
    // fallback: open image so user can long-press -> Save Image
    window.open(url, "_blank", "noopener");
    alert("Tips: H√•ll fingret p√• bilden och v√§lj 'Spara bild' / 'L√§gg till i Bilder'.");
  }
}

async function downloadOnDesktop(url, filename) {
  // Force a download (works best vs <a download> on cross-origin URLs)
  try{
    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error("Fetch failed: " + res.status);

    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = objectUrl;
    a.download = (filename || "image.jpg").replace(/[^\w.\-]+/g, "_");
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(objectUrl);
  } catch (e) {
    // fallback: open it (user can right-click -> Save image as)
    window.open(url, "_blank", "noopener");
  }
}


  // ===== Upload =====
  async function uploadToCloudinary(file){
    const endpoint = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
    const form = new FormData();
    form.append("file", file);
    form.append("upload_preset", UPLOAD_PRESET);

    // Tag + folder (allowed for unsigned upload)
    form.append("tags", EVENT_TAG);
    if (EVENT_FOLDER) form.append("folder", EVENT_FOLDER);

    const res = await fetch(endpoint, { method:"POST", body: form });
    if (!res.ok) throw new Error("Upload misslyckades (HTTP " + res.status + ")");
    const data = await res.json();
    if (!data.secure_url) throw new Error("Ingen secure_url fr√•n Cloudinary");
    return data.secure_url;
  }

  async function getRowById(id){
    const res = await fetch(`${SHEETY_API_URL}/${id}`, { cache:"no-store" });
    if (!res.ok) throw new Error("Kunde inte l√§sa spelare (HTTP " + res.status + ")");
    const json = await res.json();
    const key = Object.keys(json)[0];
    return json[key];
  }

  function normalizeGalleryToArray(galleryValue){
    if (!galleryValue) return [];
    if (Array.isArray(galleryValue)) return galleryValue.filter(Boolean);

    if (typeof galleryValue === "string"){
      const parsed = safeJsonParse(galleryValue, null);
      if (Array.isArray(parsed)) return parsed.filter(Boolean);
      if (typeof parsed === "string") return [parsed].filter(Boolean);
      return [galleryValue].filter(Boolean);
    }
    return [];
  }

  function uniqStrings(arr){
    const s = new Set();
    const out = [];
    for (const x of arr){
      const v = normalizeUrl(x);
      if (!v) continue;
      if (s.has(v)) continue;
      s.add(v);
      out.push(v);
    }
    return out;
  }

  async function putRowGallery(id, galleryArray){
    await fetch(`${SHEETY_API_URL}/${id}`, {
      method: "PUT",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        blad1: { gallery: JSON.stringify(galleryArray) }
      })
    });
  }

  async function appendUploadToMySheetyGallery(url){
    const myId = getMyId();
    if (!myId) return; // allow uploads even if not logged in, but no per-user tracking then

    const row = await getRowById(myId);
    const arr = normalizeGalleryToArray(row.gallery);
    const next = uniqStrings([url, ...arr]);
    await putRowGallery(myId, next);
  }

  async function handleUpload(files){
    const list = Array.from(files || []);
    if (!list.length) return;

    $("fileInput").value = "";
    isUploading = true;
    $("refreshBtn").disabled = true;
    $("fileInput").disabled = true;

    let ok = 0;

    for (let i = 0; i < list.length; i++){
      const f = list[i];
      try{
        setStatus(`Laddar upp (${i+1}/${list.length})‚Ä¶`);
        const url = await uploadToCloudinary(f);

        // store URL in Sheety (so we can show who uploaded)
        await appendUploadToMySheetyGallery(url);

        ok++;
      } catch (err){
        console.error(err);
        alert("Uppladdning misslyckades:\n\n" + (err?.message || err));
        break;
      }
    }

    isUploading = false;
    $("refreshBtn").disabled = false;
    $("fileInput").disabled = false;

    if (ok){
      toast(`Uppladdat! (${ok}/${list.length})`);
      await loadAllImages();
    } else {
      setStatus("");
    }
  }

  // ===== Main load =====
  async function loadAllImages({ silent=false } = {}){
    if (!silent) setStatus("Laddar bilder fr√•n Cloudinary‚Ä¶");

    try{
      // 1) Load tag list from Cloudinary
      const listJson = await fetchCloudinaryTagList();
      const resources = Array.isArray(listJson.resources) ? listJson.resources : [];

      // 2) Build URLs
      const urls = resources
        .map(buildOriginalUrlFromListItem)
        .map(normalizeUrl);

      // 3) Load Sheety map url->name (best-effort)
      const nameMap = await fetchPlayersMap();

      // 4) Merge
      allItems = urls.map(u => ({
        url: u,
        name: nameMap.get(u) || "Ok√§nd"
      }));

      render(allItems);

      if (!silent) setStatus(`Klar ‚úÖ ${allItems.length} bilder (tagg: ${EVENT_TAG})`);
    } catch (err){
      console.error(err);
      if (!silent) setStatus("");
      $("empty").style.display = "block";
      $("empty").textContent =
        "Kunde inte h√§mta Cloudinary-listan. Kontrollera att 'Resource list' √§r aktiverad och att bilderna har taggen.";
    }
  }

  // ===== Events =====
  $("refreshBtn").addEventListener("click", () => loadAllImages());

  $("fileInput").addEventListener("change", (e) => {
    handleUpload(e.target.files);
  });

  $("closeBtn").addEventListener("click", closeModal);
  $("copyBtn").addEventListener("click", copyCurrent);
  $("modal").addEventListener("click", (e)=>{ if (e.target === $("modal")) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

$("saveBtn").addEventListener("click", async () => {
  if (!current?.url) return;

  const fileName = `Ingrid80_${Date.now()}.jpg`;

  if (isDesktopDevice()) {
    await downloadOnDesktop(current.url, fileName);   // ‚úÖ desktop = download
  } else {
    await shareToPhonePhotos(current.url, fileName);  // ‚úÖ phone = save to Photos via share
  }
});


  // Init + auto refresh
  (async function init(){
    await loadAllImages();
    setInterval(() => {
      if (isUploading) return;
      if ($("modal").classList.contains("open")) return;
      loadAllImages({ silent:true });
    }, AUTO_REFRESH_MS);
  })();
</script>
</body>
</html>
